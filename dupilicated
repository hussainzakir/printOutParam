After selecting the account dropdown in the below page if it has two different accounts and I try to add both once by than after the page refresh I can see four records although I have added only two, 
this issue does not come when I am adding one record at a time. 

inc_detail_transactions_write.jsp file

<%@ taglib prefix="c" uri="http://java.sun.com/jstl/core_rt" %>
<style>
table.vertical-align > tbody > tr > td {
vertical-align: middle;
}
</style>
<form id="detailForm" method="post" name="detailForm" onsubmit="return doUpdate();" action="${requestScope['javax.servlet.forward.request_uri']}">
<input type="hidden" name="headerInvoiceStatus" value="${headerRec.invoiceStatus}"/>
<table id="writeTable" aria-describedby="writeTable" class="table table-center-alltable-sm table-no-top-border table-font-md detailInputTable table-sm table-borderless vertical-align" 
	style="border-collapse: separate; border-spacing:0 6px;">
	<thead >
		<tr class="border_bottom">
			<th scope="col">
				<input type="checkbox" class=" selectAll" id="selectAll" >
            </th>
            <c:if test="${multipleAccounts }">
            <th scope="col" class="text-center">Account</th>
            <th scope="col" class="text-center">Site</th>
            </c:if>
			<th scope="col" class="text-center">Container Description</th>
			<th scope="col" class="text-center">Charge<br/>Type</th>
			<th scope="col" class="text-center">Service<br/>Date</th>
			<th scope="col" class="text-center">Service<br/>Code</th>
			<th scope="col" class="text-center">Charge Code</th>
			<th scope="col" class="text-center">Customer<br/>PO #</th>
			<th scope="col" class="text-center">Disposal<br/>Volume</th>
			<th scope="col" class="text-center">Disposal<br/>Unit of Measure</th>
			<th scope="col" class="text-center">Amt Inv<br/>from<br/>Hauler</th>
			<th scope="col" class="text-center">Amt to be<br/>Paid to<br/>Hauler</th>
			<c:if test="${multipleAccounts }">
			<th scope="col" class="text-center">Bulk<br/>Mode</th>
			<th scope="col" class="text-center">Row<br/>Identifier</th>
			</c:if>
			<th scope="col">&nbsp;</th>
		</tr>
	</thead>
	<tbody>
	<c:set var="containerChains" value=""/>
	<c:set var="containerNonBillChains" value="-1+-1"/>
	<c:set var="containerFullChargeChains" value="-1+-1"/>
	<c:set var="urContainerTypeChains" value="-1+-1"/>

	<c:forEach var="container" items="${invoiceContainers }" varStatus="loop">
    	<c:set var="containerChains" value="${container.container} ${containerChains}"/>
    	<c:set var="containerNonBillChains" value="${container.container}+Non_Bill ${containerNonBillChains}"/>
    	<c:set var="containerFullChargeChains" value="${container.container}+Full_Charge ${containerFullChargeChains}"/>
    	<c:set var="urContainerTypeChains" value="${container.container}+-1 ${urContainerTypeChains}"/>
    	<c:forEach items="${container.containerDetails }" var="containerDetail" varStatus="loop">
    	<c:forEach var="chargeCode" items="${containerDetail.chargeCodes }">
    	<c:set var="urContainerTypeChains" value="${container.container}+${containerDetail.urNumber} ${urContainerTypeChains}"/>
    	</c:forEach>
    	</c:forEach>
	</c:forEach>
	
	<c:forEach var="transaction" items="${transactions }" varStatus="iterStatus">
		<c:set var="rowClass" value=""/>
		<c:choose>
			<c:when test="${transaction.uiIdentifier eq 'EDI Transaction'}"><c:set var="rowClass" value="table-ediRow"/></c:when>
			<c:when test="${transaction.uiIdentifier eq 'AutoPay'}"><c:set var="rowClass" value="table-autoPayRow"/></c:when>
			<c:when test="${transaction.uiIdentifier eq 'eInvoice Transaction'}"><c:set var="rowClass" value="table-eInvoiceRow"/></c:when>
		</c:choose>
		<tr  class="${rowClass }" id="row${iterStatus.count -1 }">
			<td class="text-center">
				<input type="checkbox" name="invoiceEntry[${iterStatus.count -1 }].selected"  data-varname="selected" value="true">
				<input type="hidden" name="invoiceEntry[${iterStatus.count -1 }].update" value="${not empty transaction.container }" data-varname="update">
				<input type="hidden" name="invoiceEntry[${iterStatus.count -1 }].ediTransaction" value="${transaction.uiIdentifier eq 'EDI Transaction'}" data-varname="ediTransaction">
				<input type="hidden" name="invoiceEntry[${iterStatus.count -1 }].transactionId" value="${transaction.transactionId}" data-varname="transactionId">
				
            </td>
            <c:if test="${multipleAccounts }">
            <td>
				<select class="invAccount" data-rownum="${iterStatus.count -1 }" data-varname="bulkKey.account" name="invoiceEntry[${iterStatus.count -1 }].bulkKey.account" id="invoiceEntry${iterStatus.count -1 }bulkKey.account">
				<option value="-1">&nbsp;</option>
            	<c:forEach items="${acctIds }" var="item">
					<option ${transaction.account eq item ? 'selected' :'' } value="${item }">${item }</option>
				</c:forEach>
				</select>
            </td>
            <td>
	            <select class="invSite" data-rownum="${iterStatus.count -1 }" data-varname="bulkKey.site" name="invoiceEntry[${iterStatus.count -1 }].bulkKey.site" id="invoiceEntry${iterStatus.count -1 }bulkKey.site">
					<option value="-1">&nbsp;</option>
		            <c:forEach var="site" items="${siteAccountMaps }">
						<c:set var="accounts" value="${site.value}"/>
						<c:set var="acctChain" value=""/>
						<c:set var="acctSiteChain" value=""/>
						<c:forEach var="acct" items="${accounts}">
							<c:set var="acctChain" value="${acct} ${acctChain}"/>
							<c:set var="acctSiteChain" value="${acct}+${site.key } ${acctSiteChain}"/>
					    </c:forEach>
						<option value="${site.key }" data-chained="${acctChain }" ${transaction.site eq site.key ? 'selected' :'' }>${site.key }</option>
					</c:forEach>
				</select>
            </td>
            </c:if>
			<td>
				<select class="invContainer" data-rownum="${iterStatus.count -1 }" data-varname="container" name="invoiceEntry[${iterStatus.count -1 }].container" id="invoiceEntry${iterStatus.count -1 }container">
					<option value="-1" data-chained="-1+-1 -1 ${acctSiteChain }">&nbsp;</option>
					<c:forEach var="container" items="${invoiceContainers }">
					<c:if test="${transaction.container eq container.container}">
					<c:set var="selectedContainer" value="${container }"/>
					</c:if>
					<c:set var="containerStatus" value="${container.containerCloseDate eq '0001-01-01' ? ' - Active' : ' - Inactive'}" />
					<option data-chained="${container.account }"
						${transaction.container eq container.container ? 'selected' :'' } 
						value="${container.container }"
						data-containertype="${container.containerType }"
						data-containersize="${container.containerSize }"
						data-compactor="${container.compactorflag }">${container.container } <c:out value="${container.containerDescription } ${containerStatus }"/></option>
					</c:forEach>
				</select>
				<input type="hidden" value="${transaction.serviceSource }" data-varname="serviceSource" name="invoiceEntry[${iterStatus.count -1 }].serviceSource" id="invoiceEntry${iterStatus.count -1 }serviceSource" /> 
				<input type="hidden" value="${selectedContainer.containerType }" data-varname="containerType" name="invoiceEntry[${iterStatus.count -1 }].containerType" id="invoiceEntry${iterStatus.count -1 }containerType" />
				<input type="hidden" value="${selectedContainer.containerSize }" data-varname="containerSize" name="invoiceEntry[${iterStatus.count -1 }].containerSize" id="invoiceEntry${iterStatus.count -1 }containerSize" />
				<input type="hidden" value="${selectedContainer.compactorflag }" data-varname="compactorFlag" name="invoiceEntry[${iterStatus.count -1 }].compactorFlag" id="invoiceEntry${iterStatus.count -1 }compactorFlag" />
				<input type="hidden" value="${iterStatus.count -1 }" data-varname="uiRowNumber" name="invoiceEntry[${iterStatus.count -1}].uiRowNumber" id="invoiceEntry${iterStatus.count -1}uiRowNumber" />

			</td>
			<td>
			<select class="chargeType" autocapitalize="none" data-varname="chargeType" name="invoiceEntry[${iterStatus.count -1 }].chargeType" id="invoiceEntry${iterStatus.count -1 }chargeType">
					<option value="-1" data-chained="-1 ${containerChains }">&nbsp;</option>
					<option value="Non_Bill" ${transaction.noneUrNumberType eq 'Non Bill' ? 'selected' : '' } data-chained="-1 ${containerChains }">Non Bill</option>
					<option value="Full_Charge" ${transaction.noneUrNumberType eq 'Full Charge' ? 'selected' : '' } data-chained="-1 ${containerChains }">Full Charge</option>
					<c:set var="selectedEffDate" value=""/>
					<c:set var="urFound" value="${transaction.noneUrNumberType eq 'Non Bill' or (transaction.noneUrNumberType eq 'Full Charge') }"/>
					<c:forEach var="container" items="${invoiceContainers }">
					<c:forEach items="${container.containerDetails }" var="containerDetail" varStatus="loop">
					<c:if test="${empty containerDetail.invoice or (containerDetail.invoice eq headerRec.invoiceNumber)}">
					<option data-servicesource="${containerDetail.serviceSource}" data-customerpo="${containerDetail.scheduled }" data-servicedate="${containerDetail.serviceDate }" data-servicecode="${containerDetail.serviceCode }" ${containerDetail.urNumber eq transaction.noneUrNumberType ? 'selected=selected' : '' } value="${containerDetail.urNumber }" data-chained="${container.container }"><c:out value="${containerDetail.urNumber }"/></option>
					<c:set var="urFound" value="${urFound or (containerDetail.urNumber eq transaction.noneUrNumberType) }"/>
					<c:set var="urChains" value="${containerDetail.urNumber} ${urChains}"/>
					</c:if>
					</c:forEach>
					</c:forEach>
					<c:if test="${not urFound }">
					<option data-servicesource="${transaction.serviceSource}" data-customerpo="" data-servicedate="${transaction.serviceDate }" 
					data-servicecode="${transaction.serviceCode }" selected=selected value="${transaction.noneUrNumberType }" 
					data-chained="${transaction.container }"><c:out value="${transaction.noneUrNumberType }"/></option>
					</c:if>
				</select>
			</td>
			<td><input class="datepicker" id="serviceDate" autocomplete="off" name="invoiceEntry[${iterStatus.count -1 }].serviceDate" type="text" value="${transaction.serviceDate }" size=10 data-varname="serviceDate"/></td>
			<td><input type="text" value="${transaction.serviceCode }" name="invoiceEntry[${iterStatus.count -1 }].serviceCode" size=12 data-varname="serviceCode"/> </td>
			<td>
				<select style="width: 100%;" class="chargeCode" data-varname="chargeCode" name="invoiceEntry[${iterStatus.count -1 }].chargeCode" id="invoiceEntry${iterStatus.count -1 }chargeCode">
<option value="-1" data-chained="-1+-1 -1 -1+Full_Charge -1+Non_Bill ${urChains } ${ containerNonBillChains} ${urContainerTypeChains} ${containerFullChargeChains}">&nbsp;</option>
<c:set var="selectedEffDate" value=""/>
<c:forEach var="fcCode" items="${fullchargeCodes }">
<option data-effectivedate="${fcCode.effectiveDate}" value="${fcCode.code }" ${transaction.chargeCode eq fcCode.code ? 'selected' :'' } data-chained="${fcCode.container }+Full_Charge -1+-1"><c:out value="${fcCode.description }"/></option>
<c:if test="${transaction.chargeCode eq fcCode.code }">
	<c:set var="selectedEffDate" value="${fcCode.effectiveDate }"/>
</c:if>
</c:forEach>

<c:set value="" var="nbType"/>
<c:forEach var="nonBillCode" items="${nonBillCodes }" varStatus="nbStatus">
<c:if test="${nbType ne nonBillCode.type and (not empty nbType)}"></optgroup></c:if>
<c:if test="${nbType ne nonBillCode.type}"><optgroup label="${nonBillCode.type }" data-chained="${ containerNonBillChains}"></c:if>
<c:set value="${nonBillCode.type }" var="nbType"/>
<option value="${nonBillCode.code }" ${transaction.chargeCode eq nonBillCode.code ? 'selected' :'' } data-chained="${ containerNonBillChains}"><c:out value="${nonBillCode.description }"/> </option>
<c:if test="${nbStatus.last }"></optgroup></c:if>
</c:forEach>
<c:forEach var="container" items="${invoiceContainers }">
<c:forEach items="${container.containerDetails }" var="containerDetail" varStatus="loop">
<c:forEach var="chargeCode" items="${containerDetail.chargeCodes }">
<option ${transaction.chargeCode eq chargeCode.code ? 'selected' :'' } value="${chargeCode.code }" data-chained="${container.container}+${containerDetail.urNumber}"><c:out value="${chargeCode.description }"/></option>
</c:forEach>
</c:forEach>
</c:forEach>
<c:if test="${not urFound }">
<option selected value="${transaction.chargeCode }" data-chained="${transaction.container}+${transaction.noneUrNumberType}"><c:out value="${transaction.chargeCodeDescription }"/></option>

</c:if>
</select>
<input type="hidden" value="${selectedEffDate }" data-varname="effectiveDate" name="invoiceEntry[${iterStatus.count -1}].effectiveDate" id="invoiceEntry${iterStatus.count -1}effectiveDate" />
			</td>
			<td><input type="text" name="invoiceEntry[${iterStatus.count -1 }].customerPoNumber" size=12 data-varname="customerPoNumber" value="${transaction.customerPoNumber }"/></td>
			<td><input type="text" name="invoiceEntry[${iterStatus.count -1 }].disposalVolume" size=6 data-varname="disposalVolume" value="${transaction.disposalVolume }"></td>
			<td>
			<select data-varname="disposalUom" name="invoiceEntry[${iterStatus.count -1 }].disposalUom">
					<option  value="">&nbsp;</option>
					<option ${transaction.disposalUom eq 'CA' ? 'selected' : '' } value="CA">CARTS</option>
					<option ${transaction.disposalUom eq 'EA' ? 'selected' : '' } value="EA">EACH</option>
					<option ${transaction.disposalUom eq 'GL' ? 'selected' : '' } value="GL">GALLONS</option>
					<option ${transaction.disposalUom eq 'LD' ? 'selected' : '' } value="LD">LOAD</option>
					<option ${transaction.disposalUom eq 'TN' ? 'selected' : '' } value="TN">TONS</option>
					<option ${transaction.disposalUom eq 'YD' ? 'selected' : '' } value="YD">YARDS</option>
				</select>
			</td>
			<td><input type="text" class="enterSubmittable"  name="invoiceEntry[${iterStatus.count -1 }].amtInvoicedFromHauler" size=12 data-varname="amtInvoicedFromHauler" value="${transaction.amountInvoicedFromHauler }"/></td>
			<td><input type="text" class="enterSubmittable" name="invoiceEntry[${iterStatus.count -1 }].amtToBePaidToHauler" size=12 data-varname="amtToBePaidToHauler" value="${transaction.amountToBePaidToHauler }"/></td>
			<c:set value="${amountInvoicedFromHauler +  transaction.amountInvoicedFromHauler }" var="amountInvoicedFromHauler"  scope="request" />
			<c:set value="${amountToBePaidToHauler +  transaction.amountToBePaidToHauler}" var="amountToBePaidToHauler"  scope="request" />
			<c:if test="${multipleAccounts }">
			<td>
				<select data-varname="bulkMode" name="invoiceEntry[${iterStatus.count -1 }].bulkMode">
					<option ${transaction.bulkMode eq ' ' ? 'selected' : '' } value=" ">ADD</option>
					<option ${transaction.bulkMode eq 'UPDATE' ? 'selected' : '' } value="UPDATE">UPDATE</option>
				</select>
			</td>
			<td><input type="text" class="enterSubmittable"  name="invoiceEntry[${iterStatus.count -1 }].rowIdentifier" size=12 data-varname="rowIdentifier" value="${transaction.rowIdentifier }" readonly/></td>
			</c:if>
			<td>&nbsp;</td>
		</tr>
		</c:forEach>
	</tbody>
</table>
</form>
<div><a href="javascript: void(0);" onclick="addRows(15);">Add More</a></div>



invoice_detail.jsp


<a href="${pageContext.request.contextPath}/invoice/entry/${headerRec.vendorNumber}/${vendorSubType}/${headerRec.invoiceNumber}/${fn:replace(headerRec.invoiceDate,'/','') }/${headerRec.invoiceAmount }"><img class=" back_btn" src="${pageContext.request.contextPath}/static/images/back_btn.png" alt="Back button"/></a>

<div class="container-fluid py-3 font-small">
	<h4 class="text-muted">Invoice Details</h4>
	<div class="mt-3 mx-1 mb-2 row border-bottom cursor-pointer" data-toggle="collapse" data-target="#custInfoSection" role="button" aria-expanded="false" aria-controls="collapseExample">
		<div class="col-10 px-0 mx-0">
			<h5 class="text-default" >
			<em class="fa fa-file-text-o text-danger" aria-hidden="true"></em> Invoice Header Information</h5>
		</div>
		<div class="col-2 text-right">
			<em class="fa fa-chevron-down text-muted" aria-hidden="true"></em>
		</div>
	</div>
	<form method="post" id="headerForm">
	<div class="collapse row show" id="custInfoSection">
		<div class="col-3 p-condensed">
		<p>
				<strong>Invoice Number</strong>
				<br/><c:out value="${headerRec.invoiceNumber }"/> 
			</p>
			<p>
				<strong>Invoice Date</strong>
				<br/><c:out value="${headerRec.invoiceDate }"/>
			</p>
			<p>
				<strong>Invoice Amount</strong>
				<br/>${headerRec.invoiceAmount }
			</p>
			<p>
				<strong>Invoice Notes</strong>
				<br/>
				<textarea cols="30" rows="3" class="headerChangable" name="invoiceNotes" id="invoiceNotes"><c:out value="${headerRec.invoiceNotes }"/></textarea>
				<sec:authorize access="hasAuthority(T(com.repsrv.tph2.cbs.authorization.CbsPointers).INVOICE_ENTRY)">
				<button class="btn rsibtn-orange updateHeaderBtn btn-sm" type="button" disabled onclick="postHeader();">
			  <span class="spinner-border spinner-border-sm headerSpinner d-none" role="status" aria-hidden="true"></span>
			  Update Notes
			</button>
			</sec:authorize>
			</p>
		</div>
		<div class="col-3  p-condensed">
			<p>
				<strong>Hauler Name</strong>
				<br/><c:out value="${headerRec.haulerName }"/>
			</p>
			<p>
				<strong>Hauler Number</strong>
				<br/><c:out value="${headerRec.haulerNumber }"/>
			</p>
			<p>
				<strong>Hauler Acct #</strong>
				<br/><c:out value="${headerRec.haulerAcctNumber }"/>
			</p>
			<p>
				<strong>Hauler Contact</strong>
				<br/><c:out value="${headerRec.haulerContact }" default=""/>
			</p>
			<p>
				<strong>Hauler Phone Number</strong>
				<br/><c:out value="${headerRec.haulerPhone }"/>
			</p>
			<p>
				<strong>Hauler Fax Number</strong>
				<br/><c:out value="${headerRec.haulerFax }"/>
			</p>
		</div>
		<div class="col-3  p-condensed">
			<p>
				<strong>Vendor Name</strong>
				<br/><c:out value="${headerRec.vendorName }"/>
			</p>
			<p>
				<strong>Vendor Number</strong>
				<br/> <c:out value="${headerRec.vendorNumber }"/>
			</p>
			<p>
				<strong>Vendor Terms</strong>
				<br/><c:out value="${headerRec.vendorTerms }"/>
			</p>
			<p>
				<strong>Ref ID</strong>
				<br/> <c:out value="${headerRec.referenceId }"/>
			</p>
			<p>
				<strong>Error Description</strong>
				<br/> <c:out value="${headerRec.errorDescription }"/>
			</p>
			<p>
				<strong>Invoice Status</strong>
				<br/> <span class="d-inline-block ${headerRec.invoiceStatus eq 'RVW' ? 'text-danger' : 'text-success' }"> 
				<c:choose>
					<c:when test="${headerRec.invoiceStatus eq 'RVW'}">Reviewed</c:when>
					<c:when test="${headerRec.invoiceStatus eq 'MCH'}">Matched</c:when>
					<c:when test="${headerRec.invoiceStatus eq 'INV'}">Invoiced</c:when>
					<c:otherwise>${headerRec.invoiceStatus}</c:otherwise>
				</c:choose> </span>
			</p>
		</div>
		<div class="col-3  p-condensed">
			<p>
				<c:if test="${headerRec.priorityVendor eq 'Y' }">
				<span class="text-danger"><strong>Priority Vendor</strong></span>
				<br/>
				</c:if>
				<c:choose>
					<c:when test="${empty notesUrl }">No Vendor Notes</c:when>
					<c:otherwise><a href="#" onClick="vendorNotes($(this));" data-toggle="modal"
					data-remote="${pageContext.request.contextPath}/invoice/entry/notes/${headerRec.vendorNumber }/${headerRec.haulerNumber }" >Vendor Notes</a></c:otherwise>
				</c:choose>
			</p>
			<p>&nbsp;</p>
		</div>
	</div></form>
		
	<c:choose>
		<c:when test="${multipleAccounts }">
			<jsp:include page="../components/multi_process_issues.jsp" />
		</c:when>
		<c:otherwise>
			<jsp:include page="../components/process_issues.jsp" />
		</c:otherwise>
	</c:choose>			
				
	<c:choose>
		<c:when test="${multipleAccounts }">
			<jsp:include page="../components/multi_account_site_container_detail.jsp" >
				<jsp:param value="true" name="ommitContainerStatus"/>
			</jsp:include>
		</c:when>
		<c:otherwise>
			<jsp:include page="../components/account_site_container_detail.jsp" >
				<jsp:param value="true" name="ommitContainerStatus"/>
			</jsp:include>
		</c:otherwise>
	</c:choose>
	
	<c:if test="${headerRec.invoiceStatus ne 'RVW' }">
		<div class="mt-5 mx-1 mb-2 row border-bottom cursor-pointer" data-toggle="collapse" data-target="#svcContainerReqInfoSection" role="button" aria-expanded="false" aria-controls="collapseExample">
		<div class="col-10 px-0 mx-0">
			<h5 class="text-default" >
			<em class="fa fa-file-text-o text-info" aria-hidden="true"></em> Service Container/Unscheduled Request Information</h5>
		</div>
		<div class="col-2 text-right">
			<em class="fa fa-chevron-down text-muted" aria-hidden="true"></em>
		</div>
		</div>
		<div class="row collapse show" style="height: 300px; width: 1335px; overflow-y:scroll;" id="svcContainerReqInfoSection">
		<div class="col-12">
			<c:if test="${multipleAccounts }">
		<div class="float-right"><a href="#" onClick="showURInfo($(this));" data-toggle="modal" data-remote="${pageContext.request.contextPath}/invoice/entry/multi-accts/${vendornumber}/${vendorsubtypw}/hauler-acct/${haulerAcct}">Display UR Information</a>
		</div>
			</c:if>
		<table class="table table-no-top-border table-hover" aria-describedby="resultTable" >
			<thead >
				<tr>
					<th scope="col">Account</th>
					<th scope="col">Site</th>
					<th scope="col">Container Group</th>
					<th scope="col">Container Description</th>
					<th scope="col">No. of Containers</th>
					<th scope="col">Open Comments</th>
					<th scope="col">On Call</th>
					<th scope="col">Container Status</th>
					<th scope="col">Service Frequency</th>
					<th scope="col">PO Required</th>
					<c:if test="${!multipleAccounts }">
					<th scope="col">UR Number </th>
					</c:if>
				</tr>
			</thead>
			<tbody>
				<c:if test="${empty  invoiceContainers}"><tr><td colspan="7" class="text-danger text-center">No container for this account/ No scheduled Service</td></tr></c:if>
				<c:forEach var="container" items="${invoiceContainers }">
				<tr>
					<td><c:out value="${container.account }"/></td>
					<td><c:out value="${container.site }"/></td>
					<td><c:out value="${container.container }"/><br/>
					<a target="_BLANK" href="${pageContext.request.contextPath}/container/hauler/link/${container.company}/${container.account}/${container.site}/${container.container}/cost/edit/${headerRec.vendorNumber }/${headerRec.haulerNumber }/${headerRec.haulerAcctNumber }/01010001">
					<small>Hauler Cost Rates</small>
					</a>
				</td>
					<td><c:out value="${container.containerDescription }"/></td>
					<td><c:out value="${container.quantityOnOrder }"/></td>
					<td>
						<c:choose>
							<c:when test="${container.openComments eq 'Yes'}"><a target="_BLANK" href="<c:url value="/container/comments/search/${container.company}/${container.account}/${container.site}/${container.container }" />"><c:out value="${container.openComments }"/></a></c:when>
							<c:otherwise><c:out value="${container.openComments }"/></c:otherwise>
						</c:choose>
					</td>
					<td><c:out value="${container.oncallFlag }"/></td>
					<td>
					<c:choose>
						<c:when	test="${container.containerCloseDate eq '0001-01-01'}">
							<img style="height: 30px; width: 94px;" src="${pageContext.request.contextPath}/static/images/active_btn.png" alt="Active button"/>
						</c:when>
						<c:otherwise>
						<c:set var = "dt" value = "${container.containerCloseDate}"/>
						<c:set var = "bt_bits" value = "${fn:split(dt, '-')}" />
						<img style="height: 30px; width: 94px;" src="${pageContext.request.contextPath}/static/images/inactive_btn.png" alt="Inactive button"/>
						<br/>&nbsp;<span style="padding-left: 25px;padding-top: 0px;" class="text-danger"><small>&nbsp;&nbsp;${bt_bits[1]}/${bt_bits[2]}/${bt_bits[0]}</small></span>
						</c:otherwise>
					</c:choose>
					</td>
					<td><c:out value="${container.serviceFrequency }"/><br/>
						<c:if test="${not empty container.weightLimit}">
    						Limit: <c:out value="${container.weightLimit }"/>&nbsp;&nbsp;<c:out value="${container.unitOfMeasure }"/>
						</c:if></td>
					<td><c:out value="${container.poRequired }"/></td>
					<c:if test="${!multipleAccounts }">
                    <td>
                    <c:forEach items="${container.containerDetails }" var="containerDetail" varStatus="loop">
                    <button id="ur_${containerDetail.urNumber}" class="btn btn-link p-0 urPopover ${ containerDetail.serviceSource eq 'BIPRD' ? 'text-success':''}"  data-desc="<c:out value="${containerDetail.serviceDescription }"/>" 
                        data-invoicenumber="<c:out value="${containerDetail.invoice }"/>" 
                        data-servicedate="<c:out value="${containerDetail.serviceDate }"/>" data-ponumber="<c:out value="${containerDetail.poNumber}"/>"><c:out value="${containerDetail.urNumber }"/></button>
                    <em class="fa fa-copy text-primary cursor-pointer" alt="copy to clipboard" onclick='copyToClipboard("${containerDetail.urNumber}");'></em>
                    <c:if test="${!loop.last }">
                    <br/>
                    </c:if>
                    </c:forEach>
                    </td>
					</c:if>
					</tr>
					</c:forEach>
					</tbody>
					</table>
				</div>
			</div>
		</c:if>
	<c:if test="${headerRec.invoiceStatus ne 'RVW' }">
	<div class="mt-5 mx-1 mb-2 row border-bottom cursor-pointer" data-toggle="collapse" data-target="#acctInvHistorySection" role="button" aria-expanded="false" aria-controls="collapseExample">
		<div class="col-10 px-0 mx-0">
			<h5 class="text-default" >
			<em class="fa fa-file-text-o text-default" aria-hidden="true"></em> Account Invoice History</h5>
		</div>
		<div class="col-2 text-right">
			<em class="fa fa-chevron-down text-muted" aria-hidden="true"></em>
		</div>
	</div>
	<div class="row collapse show " id="acctInvHistorySection" >
		<div class="col-12">
			<em class="fa fa-info-circle" aria-hidden="true"></em><em> The Invoice History displays the last 6 invoices.</em>
			<br/><em>&nbsp;&nbsp;&nbsp;The Invoice History only includes reviewed, matched, and error invoices.</em>
			<c:choose>
			<c:when test="${multipleAccounts }">
				<div class="float-right"><button type="button" class="btn btn-link invHistoryReport" data-reporturi="<c:url value="/reports/multi-accts/account/history/list/${headerRec.haulerAcctNumber}"/>">Display Full Hauler Invoice History</button>
			</c:when>
			<c:otherwise>
			<div class="float-right"><button type="button" class="btn btn-link invHistoryReport" data-reporturi="<c:url value="/reports/account/history/list/${customer.accountNumber}"/>">Display Full Invoice History</button>
			</c:otherwise>
		</c:choose>
			</div>
			<table class="table table-no-top-border table-hover" aria-describedby="resultTable">
					<thead >
						<tr>
							<th scope="col">Invoice Number</th>
							<th scope="col">Invoice Date</th>
							<th scope="col">Hauler Name</th>
							<th scope="col">Vendor Number</th>
							<th scope="col">Amt Invoiced from Hauler</th>
							<th scope="col">Amount Paid to Hauler</th>
							<th scope="col">Invoice Status</th>
							<th scope="col">Date Sent to PL</th>
						</tr>
					</thead>
					<tbody>
						<c:forEach items="${invHistoryList }" var="item">
						<tr>
							<td><c:out value="${item.invoiceNumber }"/></td>
							<td><c:out value="${item.invoiceDate }"/></td>
							<td><c:out value="${item.haulerName }"/></td>
							<td><c:out value="${item.vendorNumber }"/></td>
							<td class="text-right"><c:out value="${item.amountInvoicedFromHauler }"/></td>
							<td class="text-right"><c:out value="${item.amountPaidToHauler }"/></td>
							<td><c:out value="${item.invoiceStatus }"/></td>
							<td><c:out value="${item.dateSentToPl }"/></td>
						</tr>
						</c:forEach>
					</tbody>
				</table>
			</div>
		</div>
	</c:if>
	<div class="mt-5 mx-1 mb-2 row border-bottom cursor-pointer" data-toggle="collapse" data-target="#invoiceDetailsSection" role="button" aria-expanded="false" aria-controls="collapseExample">
		<div class="col-10 px-0 mx-0">
			<h5 class="text-default" >
			<em class="fa fa-file-text-o text-warning" aria-hidden="true"></em> Invoice Details</h5>
		</div>
		<div class="col-2 text-right">
			<em class="fa fa-chevron-down text-muted"  aria-hidden="true"></em>
		</div>
		</div>
		<c:if test="${headerRec.invoiceStatus ne 'RVW'}">
    	<c:if test="${multipleAccounts }">
    	<em class="fa fa-info-circle" aria-hidden="true"></em><em> The Invoice Details displays the first 50 rows. Total rows are <c:out value="${totalRecords}" />.</em>
    	<br/><em>&nbsp;&nbsp;&nbsp;To see full Invoice Details download the Bulk Template.</em>
        <br/>
        <br/>
        </c:if>
    	</c:if>
		<div class="row collapse show" id="invoiceDetailsSection" >
		<c:if test="${headerRec.invoiceStatus ne 'RVW'}">
		<c:if test="${multipleAccounts }">
		<sec:authorize access="hasAuthority(T(com.repsrv.tph2.cbs.authorization.CbsPointers).INVOICE_ENTRY)">
		<div class="col col6 text-left">
			<a href="${pageContext.request.contextPath}/invoice/entry/bulk/template/${headerRec.vendorNumber}/${vendorSubType}/${headerRec.invoiceNumber}/${headerRec.haulerAcctNumber}" onclick="setTimeout(function(){$('.busyModal').modal('hide');},500)" class="btn btn-sm btn-secondary"  >Bulk Template</a>
			&nbsp;
			<button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#bulkModal">Bulk Import</button>
		</div>
		</sec:authorize>
		</c:if>
		</c:if>
			<div class="col col6 text-right">
				<span class="ediDot align-middle"></span><span class="align-middle"> EDI Lines &nbsp;&nbsp;</span>
				<span class="eInvoiceDot align-middle"></span><span class="align-middle"> eInvoice Transaction &nbsp;&nbsp;</span>
				<span class="autoPayDot align-middle"></span><span class="align-middle"> Auto Pay &nbsp;&nbsp;</span>
				<span class="whiteDot align-middle"></span><span class="align-middle"> Empty Form</span>
			</div>
			
			<div class="table-responsive" style="height: 500px;overflow-y: scroll;overflow-x: scroll;">
				<c:set value="0.00" var="amountInvoicedFromHauler" scope="request"/>
				<c:set value="0.00" var="amountToBePaidToHauler" scope="request"/>
				<c:choose>
					<c:when test="${headerRec.invoiceStatus eq 'RVW'}">
							<jsp:include page="inc_detail_transactions_readonly.jsp"/>
					</c:when>
					<c:otherwise>
						<sec:authorize access="hasAuthority(T(com.repsrv.tph2.cbs.authorization.CbsPointers).INVOICE_ENTRY)">
						<jsp:include page="inc_detail_transactions_write.jsp"/>
						</sec:authorize>
						<sec:authorize access="!hasAuthority(T(com.repsrv.tph2.cbs.authorization.CbsPointers).INVOICE_ENTRY)">
						<jsp:include page="inc_detail_transactions_readonly.jsp"/>
						</sec:authorize>
					</c:otherwise>
				</c:choose>
				</div>
				<div class="col col-12 text-center my-2">
					<c:set var="exitUrl" value="${pageContext.request.contextPath}/invoice/entry"/>
					<c:if test="${headerRec.invoiceStatus eq 'RVW'}">
						<c:set var="exitUrl" value="${exitUrl }?accountNumber=${customer.accountNumber }" />
					</c:if>
					<a href="${exitUrl}"  
					class="btn rsibtn-orange btn-sm ">Exit</a>
					<c:if test="${headerRec.invoiceStatus ne 'RVW' }">
					    <sec:authorize access="hasAuthority(T(com.repsrv.tph2.cbs.authorization.CbsPointers).INVOICE_ENTRY)">
							<button class="btn rsibtn-orange btn-sm" onclick="doUpdate();">Update</button>
							<button class="btn rsibtn-orange btn-sm " onclick="doDelete();">Delete</button>
						</sec:authorize>
					</c:if>
			<a href="${pageContext.request.contextPath}/invoice/entry/${headerRec.vendorNumber}/${vendorSubType}/${headerRec.invoiceNumber}/${fn:replace(headerRec.invoiceDate,'/','') }/${headerRec.invoiceAmount }""  class="btn rsibtn-orange btn-sm col-2}">Back</a>
				</div>
	</div>
	<div class="row collapse show" id="invoiceDetailsSection" >
		<div class="col-3 px-0 mx-0">
		<strong>Invoice Totals for this Account</strong>
		<table class="table">
			<tr><td>Total Amount Invoiced from Hauler:</td><td><c:out value="${ totalInvoicedFromHauler}"/></td></tr>
			<tr><td>Total Amount to be Paid to Hauler:</td><td><c:out value="${totalPaidToHauler }"/></td></tr>
		</table>
		</div>
	</div>
</div>
<script>
var incomingCount = ${fn:length(transactions)};
var readOnly = ${headerRec.invoiceStatus eq 'RVW'};
var templateRow = $('#row0').clone().attr('id', 'temaplteRow');

function showURInfo(link){
	// show modal
    $('#urInfoModal').modal('show');
	$.ajax({
	       url: link.data("remote"),
	       dataType: 'html',
	       success: function(res) {
				
	           var data = res;
	           
	        	// update modal content
	           $('#urInfoModal').find('.modal-content').html(data);
	       },
	       error:function(request, status, error) {
	           console.log("ajax call went wrong:" + request.responseText);
	       }
	  });
}

$( document ).ready(function() {
	if(!readOnly){
	    $('.detailInputTable tbody tr').each(function(index){
	    	var rowNum = index
		        //setup chained
	    		initChainedSelect(rowNum);
	    });
    	addRows(incomingCount < 15 ? (15 - incomingCount) : 0 );
	}
	
	if(readOnly) {
	 	$('#invoiceNotes').prop('disabled', true);
	}

    $(".selectAll").click(function(){
    	var selectAllChecked = $(this).prop('checked');
    	$('.detailInputTable tbody tr').each(function(index){
    		var rowNum = index;
    		if(rowNum >= 0){
		        var toBeChecked = false;

    			$(this).find('td :input').each(function(index2){
    		        var varName = $(this).data('varname');
    		        var value = $(this).val();
    	    		
    		        if(!toBeChecked) {
	    		        if((varName === "container" && value !== "-1") || (varName === "chargeType" && (value !== "" && value !== "-1")) || 
	    		        		(varName === "serviceDate" && value !== "") || (varName === "serviceCode" && value !== "") 
	    		        		|| (varName === "chargeCode" && (value !== "" && value !== "-1")) || (varName === "customerPoNumber" && value !== "")
	    		        		|| (varName === "disposalVolume" && value !== "") || (varName === "disposalUom" && (value !== "" && value !== null ))
	    		        		|| (varName === "amtInvoicedFromHauler" && value !== "") || (varName === "amtToBePaidToHauler" && value !== "")) {
	    		        	toBeChecked = true;
	    		        }
    		        }    
    	        });
				if(selectAllChecked) {
	    	        if(toBeChecked) {
						$( "input[name='invoiceEntry["+rowNum+"].selected']" ).prop("checked", true);
	    	        }
				} else {
					$( "input[name='invoiceEntry["+rowNum+"].selected']" ).prop("checked", false);
				}
    		}
        });
    	
    
	});

    $('.invHistoryReport').on('click',function(){
    	doDownload($(this).data('reporturi'));
        });
		
    $(".urPopover").popover({
    	trigger: 'manual',
        title: '<h4><em class="fa fa-info-circle"></em> UR Number Detail</h4>',
        placement: 'left',
        animation: false,
        content: function(){
            
			var htmlContent = "<p>Description: "+$(this).data('desc')+'</p>'
						+"<p>Service Date: " +$(this).data('servicedate')+"</p>"
						+"<p>Invoice Number:"+$(this).data('invoicenumber')+"</p>"
						+"<p>PO #: "+$(this).data('ponumber')+"</p>";
        	return htmlContent;
            },
        html: true
    }).on('mouseenter', function () {
        var _this = this;
        $(this).popover('show');
        $('.popover').on('mouseleave', function () {
            $(_this).popover('hide');
        });
    }).on('mouseleave', function () {
        var _this = this;
        setTimeout(function () {
            if (!$('.popover:hover').length) {
                $(_this).popover('hide');
            }
        }, 10);
    });

	$(".accountPopover").popover({
        trigger: 'manual',
        title: '<h4><em class="fa fa-address-book"></em> Account Details</h4>',
        placement: 'left',
        animation: false,
        content: function(){
            
            var htmlContent = "<p>Address: " +$(this).data('address')+"</p>"
                        +"<p>City, State, Zip: "+$(this).data('city')+", "+$(this).data('state')+" "+$(this).data('zip')+"</p>";
            return htmlContent;
            },
        html: true
    }).on('mouseenter', function () {
        var _this = this;
        $(this).popover('show');
        $('.popover').on('mouseleave', function () {
            $(_this).popover('hide');
        });
    }).on('mouseleave', function () {
        var _this = this;
        setTimeout(function () {
            if (!$('.popover:hover').length) {
                $(_this).popover('hide');
            }
        }, 10);
    });

	$(".sitePopover").popover({
        trigger: 'manual',
        title: '<h4><em class="fa fa-address-book"></em> Site Details</h4>',
        placement: 'left',
        animation: false,
        content: function(){
            
            var htmlContent = "<p>Name: "+$(this).data('name')+'</p>'
                        +"<p>Address: " +$(this).data('address')+"</p>"
                        +"<p>City, State, Zip: "+$(this).data('city')+", "+$(this).data('state')+" "+$(this).data('zip')+"</p>";
            return htmlContent;
            },
        html: true
    }).on('mouseenter', function () {
        var _this = this;
        $(this).popover('show');
        $('.popover').on('mouseleave', function () {
            $(_this).popover('hide');
        });
    }).on('mouseleave', function () {
        var _this = this;
        setTimeout(function () {
            if (!$('.popover:hover').length) {
                $(_this).popover('hide');
            }
        }, 10);
    });

    var url = "${notesUrl}";

    $("#vendorNotesModal").on('hide.bs.modal', function(){
        $("#notesFrame").attr('src', '');
    });

    $("#vendorNotesModal").on('show.bs.modal', function(){
        $("#notesFrame").attr('src', url);
    });

    
	 $('.headerChangable').each(function() {
		   var elem = $(this);
		   // Save current value of element
		   elem.data('oldVal', elem.val());
		   // Look for changes in the value
		   elem.bind("propertychange change keyup input paste", 
				   function(event){
		      checkHeaderUpdates();
		   });
		 });

	    //toasts
	    <c:if test="${not empty detailUpdates}">
	    $('#successHeaderUpdates').toast('show');
	    </c:if>

	    <c:if test="${not empty detailInserts}">
	    $('#successHeaderInserts').toast('show');
	    </c:if>
	    <c:if test="${not empty detailsDeleted}">
	    $('#successDetailsDeletedToast').toast('show');
	    </c:if>

		<c:if test="${issueAdded}">
		<c:choose>
			<c:when test="${not empty issueWarningText}">
				$('#issueWarningToast').toast('show');
			</c:when>
			<c:otherwise>
				$('#issueAddedToast').toast('show');
			</c:otherwise>
		</c:choose>
		</c:if>

		<c:if test="${issueEdited}">
		<c:choose>
			<c:when test="${not empty issueWarningText}">
				$('#issueWarningToast').toast('show');
			</c:when>
			<c:otherwise>
				$('#issueUpdatedToast').toast('show');
			</c:otherwise>
		</c:choose>
		</c:if>

	    $('.invContainer').bind("change", function() {
		    console.log($(this).data('rownum'));
			var rowNum = $(this).data('rownum');
			$( "input[name='invoiceEntry["+rowNum+"].selected']" ).prop("checked", true);
		    });
	
	$("#vendorNotesModal").on("hidden.bs.modal", function(){
	$(this).find(".modal-body").html("Loading....");
	});

	$("#processingIssuesModal").on("hidden.bs.modal", function(){
	$(this).find(".modal-body").html("Loading....");
	});

	$("#addProcessIssuesModal").on("hidden.bs.modal", function(){
	$(this).find(".modal-body").html("Loading....");
	});

	$("#editProcessingIssueModal").on("hidden.bs.modal", function(){
	$(this).find(".modal-body").html("Loading....");
	});

});//end onload

function vendorNotes(link){
	// show modal
    $('#vendorNotesModal').modal('show');
	$.ajax({
	       url: link.data("remote"),
	       dataType: 'html',
	       success: function(res) {				
	           var data = res;     
	        	// update modal content
	           $('#vendorNotesModal').find('.modal-content').html(data);
	       },
	       error:function(request, status, error) {
	           console.log("ajax call went wrong:" + request.responseText);
	       }
	  });
}

function addProcessIssue(link) {
            // show modal
            $('#addProcessIssuesModal').modal('show');
            $.ajax({
                url : link.data("remote"),
                dataType : 'html',
                success : function(res) {
    
                    var data = res;
    
                    // update modal content
                    $('#addProcessIssuesModal').find('.modal-content').html(data);
    
                },
                error : function(request, status, error) {
                    console.log("ajax call went wrong:" + request.responseText);
                }
            });
        }

function editProcessingIssue(link){
	// show modal
    $('#editProcessingIssueModal').modal('show');
	$.ajax({
	       url: link.data("remote"),
	       dataType: 'html',
	       success: function(res) {				
	           var data = res;     
	        	// update modal content
	           $('#editProcessingIssueModal').find('.modal-content').html(data);
	       },
	       error:function(request, status, error) {
	           console.log("ajax call went wrong:" + request.responseText);
	       }
	  });
}

function processingIssues(link){
	// show modal
    $('#processingIssuesModal').modal('show');
	$.ajax({
	       url: link.data("remote"),
	       dataType: 'html',
	       success: function(res) {				
	           var data = res;     
	        	// update modal content
	           $('#processingIssuesModal').find('.modal-content').html(data);
	       },
	       error:function(request, status, error) {
	           console.log("ajax call went wrong:" + request.responseText);
	       }
	  });
}

var row = incomingCount;
function addRows(count){
	var startIndex = row ;
	var num = count;
	while(num > 0){
		var template = templateRow.clone()
	    .attr('id', 'row' + (row++))
	    .appendTo($('.detailInputTable tbody'))
	    .show();
	
	    num = num-1;
	}
	resetInputs(startIndex);
}

function resetInputs(startIndex){
	
	$('.detailInputTable tbody tr').each(function(index){
		var rowNum = index;
		if(rowNum >= startIndex){
			//clear styling from template
			$(this).removeClass('table-ediRow table-autoPayRow table-eInvoiceRow');
	        $(this).find('td :input').each(function(index2){
		        //id of input element
		        var varName = $(this).data('varname');
		        $(this).attr('id','invoiceEntry'+rowNum+''+varName); 
		        $(this).attr('name','invoiceEntry['+rowNum+'].'+varName);
		        $(this).data('rownum',rowNum);
				if($(this).is('select')){
					$(this).find('option').each(function() {
						$(this).removeAttr('selected');
						$(this).prop('selected', false);
					});
					$(this)[0].selectedIndex = 0;
					$(this).val('-1');
				} else if($(this).attr("id").indexOf('uiRowNumber')>-1){
					$(this).val(rowNum);
				} else if($(this).attr("id").indexOf('selected')>-1){
					//no op
				}else{
		        	$(this).val('');   
				}
	        });
		}
    });

    //loop once more to init chained selected
    $('.detailInputTable tbody tr').each(function(index){
    	var rowNum = index
    	if(rowNum >= startIndex){
	        //setup chained
    		initChainedSelect(rowNum);
    	}
    });

    //add listener to caontainer
	  $('.invContainer').each(function(index2){
		  var rowNum = $(this).data('rownum');
		  //console.log('iterating through inContainer '+rowNum);
			$(this).on("change", function(){
				var contType = $('option:selected', this).data('containertype');
				var contSize = $('option:selected', this).data('containersize');
				var compactorFlag = $('option:selected', this).data('compactor');

				$('#invoiceEntry'+rowNum+'containerType').val(contType);
				$('#invoiceEntry'+rowNum+'containerSize').val(contSize);
				$('#invoiceEntry'+rowNum+'compactorFlag').val(compactorFlag);
				//console.log('updating '+ $(this).data('rownum'));

				$( "input[name='invoiceEntry["+rowNum+"].selected']" ).prop("checked", true);
				});

			});

	  initDatePicker();
	  	//init chargeType change
	    $('.chargeType').on('change',function(){
			var svcCode = $(this).find("option:selected").data('servicecode');
			var poNum = $(this).find("option:selected").data('customerpo');
			var serviceSource = $(this).find("option:selected").data('servicesource');
			var svcDate = $(this).find("option:selected").data('servicedate');
			if(svcCode){
				var rootName = $(this).attr('name').split('.')[0];
				$('input[name="'+rootName+'.serviceCode"]').val(svcCode);
				$('input[name="'+rootName+'.serviceSource"]').val(serviceSource);
				$('input[name="'+rootName+'.customerPoNumber"]').val(poNum);
			}
		    });

		//init chargeCode
		$('.chargeCode').on('change',function(){
			var effectiveDate = $(this).find("option:selected").data('effectivedate');
			if(effectiveDate){
				var rootName = $(this).attr('name').split('.')[0];
				$('input[name="'+rootName+'.effectiveDate"]').val(effectiveDate);
				}
			});
	  	
		initEnterPress();
}

function initChainedSelect(rowNumber){
	$("#invoiceEntry"+rowNumber+"bulkKey\\.site").chained("#invoiceEntry"+rowNumber+"bulkKey\\.account");
	$("#invoiceEntry"+rowNumber+"container").chained("#invoiceEntry"+rowNumber+"bulkKey\\.account");
	 $("#invoiceEntry"+rowNumber+"chargeType").chained("#invoiceEntry"+rowNumber+"container");
     $("#invoiceEntry"+rowNumber+"chargeCode").chained("#invoiceEntry"+rowNumber+"container, #invoiceEntry"+rowNumber+"chargeType");
     
}

var headerUpdates = false;
function checkHeaderUpdates(){
	$('#invoiceNotes').val(cleanString($('#invoiceNotes').val()));
	var updates = false;
	 $('.headerChangable').each(function() {
		 var elem = $(this);
		   if(elem.data('oldVal') !=  elem.val()){
			   updates = true;
			   }
		 });

	 headerUpdates = updates;
	 if(!readOnly) {
	 	$('.updateHeaderBtn').prop('disabled', !headerUpdates);
	 }

	}

function postHeader(){
	$('.headerSpinner').removeClass('d-none');
	
	$.ajax({
	    type : 'POST',
	    url : '${pageContext.request.contextPath}/invoice/entry/${ headerRec.vendorNumber}/${ headerRec.haulerNumber}/${headerRec.invoiceNumber }/notes/update',
	    data : $('#headerForm').serialize(),
	    success: function (data) {
	    	headerUpdateCompleted(true);
        },
        error: function (e) {
        	headerUpdateCompleted(false);
        }
	});
}

function headerUpdateCompleted(success){
	setTimeout( 
	    	function(){
	    		$('.headerSpinner').addClass('d-none');
	    		if(success){
	    			$('#successHeaderUpdateToast').toast('show');
	    			$('.updateHeaderBtn').prop('disabled', true);
	    			$('.headerChangable').each(function() {
	    				   var elem = $(this);
	    				   elem.data('oldVal', elem.val());
	    				 });
	    		} else {
	    			$('#errorHeaderUpdateToast').toast('show');
	    		}
	    	}
    		,1100
	    	);
	}

function doDownload(repUri){
	showBusyModal();
	var ifrm = $('#downloadFrame');
	var clone = ifrm.clone();
	
	clone.appendTo('body');
	clone.attr('src',repUri); 
	clone.attr("onload",function(){
		$('.busyModal').modal('hide');
	});
	
	ifrm.detach();
}

var doSubmit = false;
function doUpdate(){
	console.log("1");
	if(doSubmit){
		console.log("2");
		return true;
	}
	$('#writeTable tr').removeClass("table-danger");
	//reset table errors
	 $('.detailInputTable tbody tr').each(function(index){
		$(this).removeClass("table-danger");
		$(this).find('td:last').html("&nbsp;");
		 });

	$.ajax({
	    type : 'POST',
	    url : '${requestScope['javax.servlet.forward.request_uri']}/validate', 
	    data : $('#detailForm').serialize(),
	    async: false,
	    statusCode: {
	    200: function (response) {
	    	doSubmit = true;
	        postHeader();
			console.log("3 : AJAX entered");
			$('#detailForm').submit();
			console.log("4 : AJAX after submit");
		},
	      412: function (xhr) {
	    	  doSubmit = false;
	    	  var data = xhr.responseJSON;
	    	  $.each(data, function(index, item) {
		    	  var rowId = item.uiRowNumber;
		    	  var errList = "<ul>";
		    	  $.each(item.errors,function(index2, error){ errList+="<li>"+error.errorMessage+"</li>"; });
		    	  errList += "</ul>";
		    	  var row = $('#row'+rowId);
		    	  row.addClass('table-danger');
		    	  var lasttd =  row.find('td:last');
		    	  lasttd.html('<em class="fa fa-exclamation-circle detailError" data-msg="'+errList+'" aria-hidden="true" style="font-size:20px"></em>');
	    		});
	    	  initDetailErrors();
	      }
	    }
	});
	console.log("5: AJAX exited");
	return doSubmit;
}

function initDetailErrors(){
    $(".detailError").popover({
    	trigger: 'manual',
        title: '<h5><em class="fa fa-exclamation-circle text-danger"></em> Error details</h5>',
        placement: 'left', animation: false, content: function(){ return $(this).data('msg'); }, html: true
    }).on('mouseenter', function () {
        var _this = this;
        $(this).popover('show');
        $('.popover').on('mouseleave', function () { $(_this).popover('hide'); });
    }).on('mouseleave', function () {
        var _this = this;
        setTimeout(function () {  if (!$('.popover:hover').length) { $(_this).popover('hide'); }}, 10);
    });
}

function doDelete(){
	doSubmit = true;
	var action = $('#detailForm').prop('action');
	 $('#detailForm').prop('action',action+'/delete');
	 $('#detailForm').submit();
	
}

function initEnterPress(){
	 $('.enterSubmittable').keypress(function(event){
         var keycode = (event.keyCode ? event.keyCode : event.which);
         if(keycode == '13'){
        	 doUpdate(); 
         }
         //Stop the event from propogation to other handlers
         //If this line will be removed, then keypress event handler attached 
         //at document level will also be triggered
         event.stopPropagation();
     });
}

$( document ).ready(function() {
//bulk scripts here
$('#bulkModal').on('shown.bs.modal', function () {
	hideModalBackdrop = false;
	resetBulkWizard();

	$(".step1-btn").prop('disabled', true);

	window.toggleUploadButton = function(input) {
    	if (input.files && input.files.length > 0) {
        	$(".step1-btn").prop('disabled', false);
    	} else {
        	$(".step1-btn").prop('disabled', true);
    	}
	};
	
	$(".step1-btn").click(function (event) {
		disableAndSpinButton($(this),'validating');
		submitUpload();
	});
});
});

$("#urInfoModal").on("hidden.bs.modal", function(){
		 $(this).find(".modal-body").html("Loading....");
		});

function disableAndSpinButton(btn, text){
	btn.prop("disabled", true);
	// add spinner to button
	btn.html(
	'<em class="fa fa-circle-o-notch fa-spin"></em> '+text+'...'
	);
}

function resetBulkWizard(){
	setErrorCounters(0,0,0);
	$('#bulkModal-step1').removeClass('d-none');
	$(".step1-btn").prop("disabled", true).html('Upload');

	$('#bulkModal-step2').addClass('d-none');
	$('#bulkModal-step3').addClass('d-none');
	$('.finalize-btn').addClass('d-none').prop("disabled", false).html('Submit');
	$('.retry-btn').addClass('d-none');
	$('#step1-upload-form')[0].reset();
	$('.custom-file-label').text('Select a bulk csv file');
}

var fileUploadData;
function submitUpload(){
	 //stop submit the form, we will post it manually.
    event.preventDefault();

    // Get form
    var form = $('#step1-upload-form')[0];

    // Create an FormData object 
    var data = new FormData(form);
    $.ajax({
        type: "POST",
        enctype: 'multipart/form-data',
        url: window.location.href+"/batch/upload",
        data: data,
        processData: false,
        contentType: false,
        cache: false,
        timeout: 600000,
        success: function (data) {
        	fileUploadData = data;
            $("#btnSubmit").prop("disabled", false);
            bulkStep2(fileUploadData);

        },
        error: function (e) {;
            console.log("ERROR : ", e);
            $('.error-batch_upload').html('Unkown error - please try again. ' + ee.responseText);
            $("#btnSubmit").prop("disabled", false);

        }
    });
}

function bulkStep2(validatedData){
	$('#bulkModal-step1').addClass('d-none');
	$('#bulkModal-step2').removeClass('d-none');

	//empty table
	$('#validatedReviewTable tbody').empty();

	//populate values
	var hasErrors = false;
	var rows = 0;
	var totalRowsWithErrors = 0;
	var totalBulkErrors = 0;
	$.each(validatedData, function(i, item) {

		//determine if there is an error
		var validationError = item.validationError;
		var errorsList = '';
		rows++;
		if(validationError){
			totalRowsWithErrors++
			hasErrors = true;
			var errList = "<ul>";
	    	$.each(validationError.errors,function(index2, error){ errList+="<li>"+error.errorMessage+"</li>"; totalBulkErrors++;});
	    	errList += "</ul>";
	    	errorsList = '<em class="fa fa-exclamation-circle detailError" data-msg="'+errList+'" aria-hidden="true" style="font-size:20px"></em>';
		}

		var trTag = '<tr'+ ((validationError) ? ' class="table-danger">':'>');
        var $tr = $(trTag).append(
                $('<td>').text(item.uiRowNumber).addClass('text-muted'),
            $('<td>').text(item.bulkKey.account),
            $('<td>').text(item.bulkKey.site),
            $('<td>').text(item.bulkKey.container),
            $('<td>').text(item.chargeType),
            $('<td>').text(item.serviceDate),
            $('<td>').text(item.serviceCode),
            $('<td>').text(item.chargeCode),
            $('<td>').text(item.customerPoNumber),
            $('<td>').text(item.disposalVolume),
            $('<td>').text(item.disposalUom),
            $('<td>').text(item.amtInvoicedFromHauler),
            $('<td>').text(item.amtToBePaidToHauler),
			$('<td>').text(item.bulkMode),
            $('<td>').html(errorsList)
            
        ); 

        console.log(errorsList);
		$tr.appendTo('#validatedReviewTable tbody');
		setErrorCounters(rows, totalRowsWithErrors, totalBulkErrors);
    });

    if(hasErrors || rows == 0){
    	initDetailErrors();
    	$('.retry-btn').removeClass('d-none');
    } else {
    	$('.finalize-btn').removeClass('d-none');
    }
	
}

function setErrorCounters(totalRows, totalRowsWithErrors, totalBulkErrors){
	$('.total-bulk-rows').text(totalRows);
	$('.total-bulk-row-errors').text(totalRowsWithErrors);
	$('.total-bulk-errors').text(totalBulkErrors);
}

function finalizeBulkWizard(btn){

	disableAndSpinButton(btn, ' saving...');
	var payload = {};
	payload.headerInvoiceStatus = '${headerRec.invoiceStatus}';
	payload.rows = fileUploadData;
	//post the data back to the BE
	$.ajax({
	    contentType: 'application/json',
	    data: JSON.stringify(payload),
	    success: function(data){
		    alert('Bulk import success!  Click OK to load the new data.');
	    	location.reload(true);
	    },
	    error: function(){
	       alert('Unknown error has occured');
	    },
	    processData: true,
	    type: 'POST',
	    url: window.location.href+'/batch/upload/save'
	});
}
</script>
<script src="${pageContext.request.contextPath}/static/js/jquery.chained.min.js?dfgdfg=e434dsdffdf5"></script>
<iframe id="downloadFrame" src="" style="display: none" ></iframe>


<div class="modal fade dark-modal" id="vendorNotesModal" tabindex="-1" role="dialog">
	<div class="modal-dialog mw-100 w-75" role="document">
		<div class="modal-content px-3">
			 Loading ....
		</div>
	</div>
	</div>

<div class="modal fade dark-modal" id="processingIssuesModal" tabindex="-1" role="dialog">
	<div class="modal-dialog mw-100 w-50" role="document">
		<div class="modal-content px-3">
				 Loading ....
		</div>
	</div>
	</div>

	<div class="modal fade dark-modal" id="addProcessIssuesModal" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content px-3">
					 Loading ....
			</div>
		</div>
		</div>

	<div class="modal fade dark-modal" id="editProcessingIssueModal" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content px-3">
					 Loading ....
			</div>
		</div>
		</div>

<c:if test="${multipleAccounts }">
<div id="bulkModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-height:600px;">
    <div class="modal-content" style=" height:100%">
	    <div class="modal-header">
	        <h5 class="modal-title"><i class="fa fa-upload" aria-hidden="true"></i> Batch Load Invoices</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body" style="overflow:auto; height:100%;">
	        <div id="bulkModal-step1">
				<div class="container">
					<div class="row">
						<div class="col-sm-5 offset-md-2">
							Upload a bulk invoice file below - you can find a template 
							<a href="${pageContext.request.contextPath}/invoice/entry/bulk/template/${headerRec.vendorNumber}/${vendorSubType}/${headerRec.invoiceNumber}/${headerRec.haulerAcctNumber}"onclick="setTimeout(function(){$('.busyModal').modal('hide');},500)">here</a>.
						</div>
					</div>
				</div>
				<div class="container">
					<div class="row">
						<div class="col col-lg-5 offset-md-2">
							<form method="POST" enctype="multipart/form-data" id="step1-upload-form">
								<div class="custom-file">
									<input type="file" class="custom-file-input" accept=".csv" id="bulkFile" name="bulkFile" 
									onchange="this.nextElementSibling.innerText = this.files[0].name; toggleUploadButton(this)">
									<label class="custom-file-label" for="bulkFile" data-browse="Select file">Select a bulk csv file</label>
								</div>
								<br/>
								<br/>
								<button type="submit" class="btn btn-primary step1-btn" disabled>Upload</button>
							</form>
							<span class="error-batch_upload"></span>
						</div>
					</div>
				</div>
			</div>
	        
	        <div id="bulkModal-step2" class="d-none table-responsive-container" style="height: 600px;">
	        	<div class="container"><div class="row"><div class="col-sm-4 offset-md-4"><h4>Validation/Review </h4></div></div></div>
	         <div class="container">
	        <div class="row">
			  <div class="col-sm-4 offset-md-4">
			        <ul class="list-group">
					  <li class="list-group-item d-flex justify-content-between align-items-center">
					   Total Row Count
					    <span class="badge badge-primary badge-pill total-bulk-rows"></span>
					  </li>
					  <li class="list-group-item d-flex justify-content-between align-items-center">
					    Total Rows w/ Errors
					    <span class="badge badge-warning badge-pill total-bulk-row-errors"></span>
					  </li>
					  <li class="list-group-item d-flex justify-content-between align-items-center">
					    Total Errors
					    <span class="badge badge-danger badge-pill total-bulk-errors"></span>
					  </li>
					</ul>
			  </div>
  			</div>
  			</div>
	        	<table id="validatedReviewTable" class="table table-hover static-header table-sm table-borderless vertical-align" 
	style="border-collapse: separate; border-spacing:0 6px;">
	<thead >
		<tr class="border_bottom">
			<th class="text-muted">Row #</th>
            <th>Account</th>
            <th>Site</th>
			<th>Container</th>
			<th>Charge<br/>Type</th>
			<th>Service<br/>Date</th>
			<th>Service<br/>Code</th>
			<th>Charge Code</th>
			<th>Customer<br/>PO #</th>
			<th>Disposal<br/>Volume</th>
			<th>Disposal<br/>UOM</th>
			<th>Amt Inv<br/>from<br/>Hauler</th>
			<th>Amt to be<br/>Paid to<br/>Hauler</th>
			<th>Bulk<br/>Mode</th>
			<th>&nbsp;</th>
		</tr>
	</thead>
	<tbody>
	
	</tbody>
	</table>
	        </div>
	        
	        <div id="bulkModal-step3" class="d-none">
	        	Success!  Bulk upload processed.  Click here to refresh the page.
	        </div>
	      </div>
      	<div class="modal-footer">
      	<button type="button" class="btn btn-secondary retry-btn d-none" onclick="resetBulkWizard();">Re-Upload</button>
      	<button type="button" class="btn btn-secondary finalize-btn d-none" onclick="finalizeBulkWizard($(this));">Submit</button>
        <button type="button" class="btn rsibtn-orange" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
</c:if>

<div class="modal fade dark-modal" id="urInfoModal" tabindex="-1" role="dialog">
	<div class="modal-dialog mw-100 w-75" role="document">
		<div class="modal-content">
		     Loading ....
		</div>
	</div>
	</div>

<div class="toast bg-success text-white" style="position: absolute; top: 80px; right:10px;width:450px;" id="successHeaderUpdateToast"  data-autohide="true" data-delay="5000">
    <div class="toast-body">
        <div><em class="fa fa-check"></em> Success! Invoice header updated!</div>
    </div>
</div>
<div class="toast bg-success text-white" style="position: absolute; top: 80px; right:10px;width:450px;" id="issueAddedToast"  data-autohide="true" data-delay="5000">
    <div class="toast-body">
        <div><em class="fa fa-check"></em> Success! Processing Issue has been added!</div>
    </div>
</div>
<div class="toast bg-success text-white" style="position: absolute; top: 80px; right:10px;width:450px;" id="issueUpdatedToast"  data-autohide="true" data-delay="5000">
    <div class="toast-body">
        <div><em class="fa fa-check"></em> Success! Processing Issue has been edited!</div>
    </div>
</div>
<div class="toast bg-primary text-white" style="position: absolute; top: 80px; right:10px;width:450px;" id="issueWarningToast"  data-autohide="true" data-delay="5000">
    <div class="toast-body">
        <div><em class="fa fa-check"></em> Warning! <c:out value = "${issueWarningText}"/></div>
    </div>
</div>
<div class="toast bg-success text-white" id="successHeaderUpdates"  data-autohide="true" data-delay="5000" style="position: absolute; top: 80px; right:10px;width:450px;">
    <div class="toast-body">
        <div><em class="fa fa-check"></em> Success! ${detailUpdates } records updated.</div>
    </div>
</div>

<div class="toast bg-success text-white" id="successHeaderInserts"  data-autohide="true" data-delay="5000" style="position: absolute; top: 80px; right:10px;width:450px;">
    <div class="toast-body">
        <div><em class="fa fa-check"></em> Success! ${detailInserts } records inserted.</div>
    </div>
</div>
<div class="toast ml-auto bg-warning text-white" id="errorHeaderUpdateToast"  data-autohide="true" data-delay="5000" style="position: absolute; top: 80px; right:10px;width:450px;">
    <div class="toast-body">
        <div><em class="fa fa-exclamation-triangle"></em> Unknown error updating Invoice header.</div>
    </div>
</div>
<div class="toast bg-success text-white" id="successDetailsDeletedToast"  data-autohide="true" data-delay="5000" style="position: absolute; top: 80px; right:10px;width:450px;">
    <div class="toast-body">
        <div><em class="fa fa-check"></em> Success! ${detailsDeleted } records were deleted!</div>
    </div>
</div>
